<% content_for :title, "Loans" %>

<main class="page">
  <header class="page__header">
    <div>
      <p class="eyebrow">Portfolio</p>
      <h1>Loans</h1>
      <p class="lede">Review existing loans and upload a CSV to add more.</p>
    </div>

    <div class="upload-panel">
      <%= form_with url: import_loans_path, multipart: true, class: "upload-form", local: true do |form| %>
        <div class="upload-form__field">
          <%= form.label :file, "Upload Loan Data CSV File", class: "label" %>
          <div class="file-input">
            <%= form.file_field :file, accept: ".csv", required: true %>
            <span class="hint">Expected headers: loan_number, origination_date, amortization_period, payment_date, unpaid_principal_balance, interest_rate, net_operating_income, is_interest_only</span>
          </div>
        </div>
        <%= form.submit "Upload CSV", class: "btn" %>
      <% end %>
    </div>
  </header>

  <% if flash[:notice] %>
    <p class="flash flash--success"><%= flash[:notice] %></p>
  <% end %>

  <% if flash[:alert] %>
    <p class="flash flash--error"><%= flash[:alert] %></p>
  <% end %>

  <div class="table-card">
    <div class="table-card__header">
      <h2>All loans</h2>
      <p class="pill"><%= @loans.size %> total</p>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>Loan #</th>
            <th>Origination Date</th>
            <th>Amortization Period (mo)</th>
            <th>Payment Date</th>
            <th>Unpaid Principal Balance</th>
            <th>Interest Rate</th>
            <th>Net Operating Income</th>
            <th>DSCR</th>
            <th>Interest Only?</th>
          </tr>
        </thead>
        <tbody>
          <% if @loans.any? %>
            <% @loans.each do |loan| %>
              <tr>
                <td><%= loan.loan_number %></td>
                <td><%= loan.origination_date.present? ? loan.origination_date.strftime("%m/%d/%Y") : "-" %></td>
                <td><%= loan.amortization_period.present? ? loan.amortization_period : "-" %></td>
                <td><%= loan.payment_date.present? ? loan.payment_date.strftime("%m/%d/%Y") : "-" %></td>
                <td><%= number_to_currency(loan.unpaid_principal_balance) %></td>
                <td><%= loan.interest_rate.present? ? number_to_percentage(loan.interest_rate * 100, precision: 3) : "—" %></td>
                <td><%= loan.net_operating_income.present? ? number_to_currency(loan.net_operating_income) : "—" %></td>
                <td><%= loan.dscr.present? ? number_with_precision(loan.dscr, precision: 3) : "—" %></td>
                <td><%= loan.is_interest_only ? "Yes" : "No" %></td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="9" class="empty">No loans yet. Upload a CSV to get started.</td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</main>
